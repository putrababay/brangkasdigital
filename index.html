<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ultimate Secure Vault</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css"
      rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
      rel="stylesheet" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      rel="stylesheet" />

    <style>
      body {
        background: #121212;
        color: #e0e0e0;
        font-family: Segoe UI;
        padding: 15px;
      }
      .container {
        background: #1e1e1e;
        padding: 20px;
        border-radius: 15px;
        border: 1px solid #333;
      }
      .form-control,
      .form-select {
        background: #2d2d2d !important;
        border: 1px solid #444 !important;
        color: #fff !important;
      }
      .input-group-text {
        background: #333;
        border: 1px solid #444;
        color: #0dcaf0;
        cursor: pointer;
      }
      .modal-content {
        background: #1e1e1e;
        border: 1px solid #444;
      }
      .table-dark {
        --bs-table-bg: #1e1e1e;
        font-size: 0.85rem;
      }
      .swal-mini-input {
        width: 85% !important;
        margin: 10px auto !important;
        text-align: center;
      }
      #loginOverlay {
        position: fixed;
        inset: 0;
        background: #0f0f0f;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .login-card {
        width: 90%;
        max-width: 320px;
        padding: 35px;
        background: #1a1a1a;
        border-radius: 20px;
        border: 1px solid #333;
        text-align: center;
      }
      .pin-input-modern {
        letter-spacing: 10px;
        font-size: 24px;
        font-weight: bold;
        background: #252525 !important;
        border: none;
        border-bottom: 2px solid #0d6efd;
        border-radius: 0;
        color: #0dcaf0 !important;
      }
      @media (max-width: 576px) {
        .action-col {
          display: none;
        }
        .dataTables_length,
        .dataTables_info {
          display: none !important;
        }
      }
    </style>
  </head>

  <body>
    <div id="loginOverlay">
      <div class="login-card">
        <i class="fas fa-fingerprint fa-3x text-primary mb-3"></i>
        <h5 class="mb-4">Secure Vault</h5>
        <input
          id="pinInput"
          type="password"
          class="form-control pin-input-modern text-center mb-4"
          maxlength="6"
          placeholder="******" />
        <button class="btn btn-primary w-100 rounded-pill" onclick="checkPin()">
          VERIFIKASI
        </button>
      </div>
    </div>

    <div id="mainApp" style="display: none">
      <div class="container">
        <div class="d-flex justify-content-between mb-3">
          <h4><i class="fas fa-vault text-warning"></i> Brankas Cloud</h4>
          <button class="btn btn-primary btn-sm" onclick="openModalAdd()">
            <i class="fas fa-plus"></i> Baru
          </button>
        </div>

        <table
          id="accountTable"
          class="table table-dark table-hover dt-responsive nowrap w-100">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Username</th>
              <th class="text-end action-col">Aksi</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="myModal" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-secondary">
            <h5 id="modalTitle">Form Akun</h5>
            <button
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="accountForm">
              <input type="hidden" id="editId" />
              <div class="mb-2">
                <label>Kategori</label
                ><input id="kategori" class="form-control" required />
              </div>
              <div class="mb-2">
                <label>Username</label
                ><input id="username" class="form-control" required />
              </div>
              <div class="mb-2">
                <label>Password</label>
                <div class="input-group">
                  <input
                    id="password"
                    type="password"
                    class="form-control"
                    required />
                  <span
                    class="input-group-text"
                    onclick="toggleView('password')"
                    ><i class="fa fa-eye"></i
                  ></span>
                </div>
              </div>
              <div class="row">
                <div class="col-6">
                  <label>PIN</label>
                  <input id="pin" type="password" class="form-control" />
                </div>
                <div class="col-6">
                  <label>Pola</label>
                  <input id="pola" type="password" class="form-control" />
                </div>
              </div>
              <div class="mb-3">
                <label>Catatan</label
                ><textarea id="riwayat" class="form-control"></textarea>
              </div>
              <button class="btn btn-success w-100">SIMPAN</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
      let VAULT = { auth: false, key: null };

      function toggleView(id) {
        const i = document.getElementById(id);
        i.type = i.type === "password" ? "text" : "password";
      }

      async function checkPin() {
        const pin = $("#pinInput").val().trim();
        if (!pin) return Swal.fire("Error", "PIN wajib diisi", "error");
        if (pin !== "123456") return Swal.fire("Error", "PIN Salah", "error"); // DEMO
        sessionStorage.setItem("vault_auth", "true");
        VAULT.auth = true;
        $("#loginOverlay").fadeOut();
        $("#mainApp").show();
        renderTable();
      }

      async function askSecret() {
        if (VAULT.key) return VAULT.key;
        $(".modal.show").modal("hide");
        const { value } = await Swal.fire({
          title: "Otorisasi",
          html: `<input id="secretKey" type="password" class="swal2-input swal-mini-input" placeholder="Secret Key">`,
          showCancelButton: true,
          allowOutsideClick: false,
          didOpen: () => document.getElementById("secretKey").focus(),
          preConfirm: () => {
            const v = document.getElementById("secretKey").value;
            if (!v) Swal.showValidationMessage("Wajib diisi");
            return v;
          },
        });
        if (!value) return null;
        VAULT.key = value;
        return value;
      }

      async function renderTable() {
        const data = JSON.parse(localStorage.getItem("vault_data") || "[]");
        let html = "";
        data.forEach((x, i) => {
          html += `<tr>
      <td>${x.kategori}</td>
      <td>${x.username}</td>
      <td class="text-end action-col">
        <button class="btn btn-info btn-sm" onclick="view(${i})"><i class="fa fa-eye"></i></button>
        <button class="btn btn-warning btn-sm" onclick="edit(${i})"><i class="fa fa-edit"></i></button>
        <button class="btn btn-danger btn-sm" onclick="del(${i})"><i class="fa fa-trash"></i></button>
      </td>
    </tr>`;
        });
        $("#tableBody").html(html);
        if ($.fn.DataTable.isDataTable("#accountTable"))
          $("#accountTable").DataTable().destroy();
        $("#accountTable").DataTable({ responsive: true, lengthChange: false });
      }

      async function view(i) {
        const key = await askSecret();
        if (!key) return;
        const d = JSON.parse(localStorage.getItem("vault_data"))[i];
        try {
          const pass = CryptoJS.AES.decrypt(d.password, key).toString(
            CryptoJS.enc.Utf8
          );
          if (!pass) throw 0;
          Swal.fire(
            "Detail",
            `<b>${d.username}</b><br>Password: ${pass}`,
            "info"
          );
        } catch {
          VAULT.key = null;
          Swal.fire("Error", "Secret Key Salah", "error");
        }
      }

      async function edit(i) {
        const key = await askSecret();
        if (!key) return;
        const d = JSON.parse(localStorage.getItem("vault_data"))[i];
        $("#editId").val(i);
        $("#kategori").val(d.kategori);
        $("#username").val(d.username);
        $("#password").val(
          CryptoJS.AES.decrypt(d.password, key).toString(CryptoJS.enc.Utf8)
        );
        $("#myModal").modal("show");
      }

      async function del(i) {
        const ok = await Swal.fire({ title: "Hapus?", showCancelButton: true });
        if (ok.isConfirmed) {
          const d = JSON.parse(localStorage.getItem("vault_data"));
          d.splice(i, 1);
          localStorage.setItem("vault_data", JSON.stringify(d));
          renderTable();
        }
      }

      $("#accountForm").on("submit", async function (e) {
        e.preventDefault();
        const key = await askSecret();
        if (!key) return;
        const data = JSON.parse(localStorage.getItem("vault_data") || "[]");
        const enc = (v) => CryptoJS.AES.encrypt(v, key).toString();
        const obj = {
          kategori: $("#kategori").val(),
          username: $("#username").val(),
          password: enc($("#password").val()),
        };
        const id = $("#editId").val();
        if (id === "") data.push(obj);
        else data[id] = obj;
        localStorage.setItem("vault_data", JSON.stringify(data));
        $("#myModal").modal("hide");
        renderTable();
        Swal.fire("Sukses", "Data tersimpan", "success");
      });

      function openModalAdd() {
        $("#editId").val("");
        $("#accountForm")[0].reset();
        $("#myModal").modal("show");
      }
    </script>
  </body>
</html>
