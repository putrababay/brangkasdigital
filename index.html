<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ultimate Cloud Vault</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

    <style>
      body {
        background-color: #121212;
        color: #e0e0e0;
        padding: 20px;
      }
      .container {
        background: #1e1e1e;
        padding: 25px;
        border-radius: 15px;
        border: 1px solid #333;
      }
      .form-control {
        background-color: #2d2d2d;
        border: 1px solid #444;
        color: white !important;
      }
      .modal-content {
        background-color: #1e1e1e;
        color: white;
        border: 1px solid #444;
      }
      .table-dark {
        --bs-table-bg: #1e1e1e;
      }
      #loginOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #121212;
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .login-card {
        width: 100%;
        max-width: 350px;
        padding: 30px;
        background: #1e1e1e;
        border-radius: 15px;
        border: 1px solid #444;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="loginOverlay">
      <div class="login-card">
        <i class="fas fa-lock fa-4x text-warning mb-4"></i>
        <h4>Masukan PIN Login</h4>
        <input
          type="password"
          id="pinInput"
          class="form-control text-center mb-3 mt-4"
          maxlength="6"
          placeholder="******" />
        <button class="btn btn-primary w-100" onclick="checkPin()">
          MASUK
        </button>
      </div>
    </div>

    <div id="mainApp" style="display: none">
      <div class="container">
        <div
          class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
          <h3><i class="fas fa-vault text-warning"></i> Brankas Cloud D1</h3>
          <button class="btn btn-primary" onclick="openModalAdd()">
            <i class="fas fa-plus"></i> Akun Baru
          </button>
        </div>

        <table
          id="accountTable"
          class="table table-dark table-hover dt-responsive nowrap"
          style="width: 100%">
          <thead>
            <tr>
              <th>Kategori</th>
              <th>Username</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div
      class="modal fade"
      id="myModal"
      tabindex="-1"
      aria-hidden="true"
      data-bs-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Form Data</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="accountForm">
              <input type="hidden" id="editId" />
              <div class="mb-3">
                <label class="form-label">Nama Aplikasi</label>
                <input
                  type="text"
                  id="kategori"
                  class="form-control"
                  required />
              </div>
              <div class="mb-3">
                <label class="form-label">Username</label>
                <input
                  type="text"
                  id="username"
                  class="form-control"
                  required />
              </div>
              <div class="mb-3">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  id="password"
                  class="form-control"
                  required />
              </div>
              <div class="row mb-3">
                <div class="col-6">
                  <label class="form-label">PIN</label
                  ><input type="password" id="pin" class="form-control" />
                </div>
                <div class="col-6">
                  <label class="form-label">Pola</label
                  ><input type="password" id="pola" class="form-control" />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Catatan</label>
                <textarea id="riwayat" class="form-control" rows="2"></textarea>
              </div>
              <button type="submit" class="btn btn-success w-100 py-2">
                <b>SIMPAN KE CLOUD</b>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
      let table = null;

      // 1. Fungsi Login PIN
      async function checkPin() {
        const pin = $("#pinInput").val();
        const hashedPin = CryptoJS.SHA256(pin).toString();

        const response = await fetch("/api/verify-pin", {
          method: "POST",
          body: JSON.stringify({ pin: hashedPin }),
        });

        if (response.ok) {
          $("#loginOverlay").fadeOut();
          $("#mainApp").show();
          renderTable();
        } else {
          Swal.fire("Gagal", "PIN Salah!", "error");
        }
      }

      // 2. Fungsi Verifikasi SECRET_KEY (Selalu ditanya saat aksi penting)
      async function askSecretKey() {
        const { value: key } = await Swal.fire({
          title: "Input SECRET_KEY",
          text: "Dibutuhkan untuk Enkripsi/Dekripsi data",
          input: "password",
          showCancelButton: true,
          confirmButtonText: "Proses",
        });
        return key;
      }

      async function renderTable() {
        const response = await fetch("/api/accounts");
        const data = await response.json();

        if ($.fn.DataTable.isDataTable("#accountTable"))
          $("#accountTable").DataTable().destroy();

        let html = "";
        data.forEach((item) => {
          html += `<tr>
                <td>${item.kategori}</td>
                <td>${item.username}</td>
                <td><span class="badge bg-success">Encrypted</span></td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="handleAction(${item.id}, 'view')"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="handleAction(${item.id}, 'delete')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        });
        $("#tableBody").html(html);
        $("#accountTable").DataTable({ responsive: true });
      }

      async function handleAction(id, type) {
        const key = await askSecretKey();
        if (!key) return;

        const response = await fetch("/api/accounts");
        const db = await response.json();
        const item = db.find((x) => x.id === id);

        try {
          if (type === "view") {
            const pass = CryptoJS.AES.decrypt(item.password, key).toString(
              CryptoJS.enc.Utf8
            );
            if (!pass) throw new Error();

            Swal.fire({
              title: item.kategori,
              html: `<div class="text-start bg-light p-3 text-dark"><b>Pass:</b> ${pass}<br><b>Note:</b> ${item.riwayat}</div>`,
            });
          } else if (type === "delete") {
            const res = await Swal.fire({
              title: "Hapus data?",
              showCancelButton: true,
            });
            if (res.isConfirmed) {
              await fetch(`/api/accounts?id=${id}`, { method: "DELETE" });
              renderTable();
            }
          }
        } catch (e) {
          Swal.fire("Gagal", "SECRET_KEY Salah!", "error");
        }
      }

      $("#accountForm").on("submit", async function (e) {
        e.preventDefault();
        const key = await askSecretKey();
        if (!key) return;

        const data = {
          kategori: $("#kategori").val(),
          username: $("#username").val(),
          password: CryptoJS.AES.encrypt($("#password").val(), key).toString(),
          pin: $("#pin").val()
            ? CryptoJS.AES.encrypt($("#pin").val(), key).toString()
            : "",
          pola: $("#pola").val()
            ? CryptoJS.AES.encrypt($("#pola").val(), key).toString()
            : "",
          riwayat: $("#riwayat").val(),
        };

        const res = await fetch("/api/accounts", {
          method: "POST",
          body: JSON.stringify(data),
        });

        if (res.ok) {
          $("#myModal").modal("hide");
          renderTable();
          Swal.fire(
            "Sukses",
            "Data disimpan dengan SECRET_KEY Anda",
            "success"
          );
        }
      });

      function openModalAdd() {
        $("#accountForm")[0].reset();
        $("#myModal").modal("show");
      }
    </script>
  </body>
</html>
