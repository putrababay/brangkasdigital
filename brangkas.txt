<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Secure Vault</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body { background-color: #121212; color: #e0e0e0; padding: 20px; }
        .container { background: #1e1e1e; padding: 25px; border-radius: 15px; border: 1px solid #333; }
        .form-control, .form-select { background-color: #2d2d2d; border: 1px solid #444; color: white !important; }
        .form-control:focus { background-color: #333; border-color: #0d6efd; box-shadow: none; color: white; }
        .modal-content { background-color: #1e1e1e; color: white; border: 1px solid #444; }
        .input-group-text { background-color: #333; border: 1px solid #444; color: #0dcaf0; cursor: pointer; }
        .table-dark { --bs-table-bg: #1e1e1e; }
        /* Memperbaiki z-index sweetalert supaya bisa diketik */
        .swal2-container { z-index: 10000 !important; }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4 text-wrap">
        <h3><i class="fas fa-vault text-warning"></i> Brankas Akun Digital</h3>
        <button class="btn btn-primary" onclick="openModalAdd()"><i class="fas fa-plus"></i> Akun Baru</button>
    </div>

    <table id="accountTable" class="table table-dark table-hover dt-responsive nowrap" style="width:100%">
        <thead>
            <tr>
                <th>Kategori</th>
                <th>Username</th>
                <th>Password</th>
                <th>PIN/Pola</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<div class="modal fade" id="myModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Form Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="editIndex">
                    <div class="mb-3">
                        <label class="form-label">Kategori / Nama Aplikasi</label>
                        <input type="text" id="kategori" class="form-control" placeholder="Contoh: Facebook, M-Banking" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username / Email</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <div class="input-group">
                            <input type="password" id="password" class="form-control" required>
                            <span class="input-group-text" onclick="toggleView('password')"><i class="fas fa-eye" id="eye-password"></i></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">PIN</label>
                            <div class="input-group">
                                <input type="password" id="pin" class="form-control">
                                <span class="input-group-text" onclick="toggleView('pin')"><i class="fas fa-eye" id="eye-pin"></i></span>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Pola</label>
                            <div class="input-group">
                                <input type="password" id="pola" class="form-control">
                                <span class="input-group-text" onclick="toggleView('pola')"><i class="fas fa-eye" id="eye-pola"></i></span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Riwayat / Catatan Tambahan</label>
                        <textarea id="riwayat" class="form-control" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2"><b>ENKRIPSI & SIMPAN</b></button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
    // Kunci Rahasia Default
    const MASTER_KEY = "admin123";
    let table;

    $(document).ready(function() {
        renderTable();
    });

    // Perbaikan Fungsi AskKey: Menghapus tab-index modal sementara agar SweetAlert aktif
    async function askKey() {
        // Matikan sementara fokus modal agar Sweetalert bisa diketik
        $('#myModal').modal('hide'); 
        
        const { value: key } = await Swal.fire({
            title: 'Verifikasi Kunci',
            text: 'Masukkan SECRET_KEY untuk melanjutkan',
            input: 'password',
            inputAttributes: {
                autocapitalize: 'off',
                autocorrect: 'off'
            },
            showCancelButton: true,
            confirmButtonText: 'Buka Akses',
            allowOutsideClick: false
        });

        if (!key) return null;
        
        if (key === MASTER_KEY) {
            return key;
        } else {
            await Swal.fire('Gagal', 'Kunci Salah!', 'error');
            return null;
        }
    }

    function toggleView(id) {
        const input = document.getElementById(id);
        const icon = document.getElementById('eye-' + id);
        input.type = input.type === "password" ? "text" : "password";
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    }

    function renderTable() {
        const data = JSON.parse(localStorage.getItem('vault_v3')) || [];
        if ($.fn.DataTable.isDataTable('#accountTable')) table.destroy();

        let html = '';
        data.forEach((item, index) => {
            html += `
                <tr>
                    <td><b>${item.kategori}</b></td>
                    <td>${item.username}</td>
                    <td><span class="text-muted small"><i>Terenkripsi</i></span></td>
                    <td><span class="text-muted small"><i>Terenkripsi</i></span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-info" onclick="handleAction(${index}, 'view')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="handleAction(${index}, 'edit')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="handleAction(${index}, 'delete')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        });
        $('#tableBody').html(html);
        table = $('#accountTable').DataTable({ 
            responsive: true,
            language: { search: "Cari:" }
        });
    }

    async function handleAction(index, type) {
        const key = await askKey();
        if (!key) return;

        const db = JSON.parse(localStorage.getItem('vault_v3'));
        const item = db[index];

        try {
            const pass = CryptoJS.AES.decrypt(item.password, key).toString(CryptoJS.enc.Utf8);
            const pin = CryptoJS.AES.decrypt(item.pin, key).toString(CryptoJS.enc.Utf8);
            const pola = CryptoJS.AES.decrypt(item.pola, key).toString(CryptoJS.enc.Utf8);

            if (type === 'view') {
                Swal.fire({
                    title: item.kategori,
                    html: `
                        <div class="text-start bg-light p-3 rounded text-dark">
                            <b>Username:</b> ${item.username}<br>
                            <b>Password:</b> <span class="badge bg-danger">${pass}</span><br>
                            <b>PIN:</b> ${pin || '-'}<br>
                            <b>Pola:</b> ${pola || '-'}<br><hr>
                            <b>Catatan:</b> ${item.riwayat}
                        </div>`,
                    icon: 'info'
                });
            } else if (type === 'edit') {
                $('#editIndex').val(index);
                $('#kategori').val(item.kategori);
                $('#username').val(item.username);
                $('#password').val(pass);
                $('#pin').val(pin);
                $('#pola').val(pola);
                $('#riwayat').val(item.riwayat);
                $('#modalTitle').text('Update Data');
                $('#myModal').modal('show');
            } else if (type === 'delete') {
                db.splice(index, 1);
                localStorage.setItem('vault_v3', JSON.stringify(db));
                renderTable();
                Swal.fire('Berhasil', 'Data telah dihapus', 'success');
            }
        } catch (e) {
            Swal.fire('Error', 'Gagal dekripsi data!', 'error');
        }
    }

    $('#accountForm').on('submit', async function(e) {
        e.preventDefault();
        
        // Konfirmasi kunci sebelum menyimpan
        const key = await askKey();
        if (!key) return;

        const index = $('#editIndex').val();
        const dataBaru = {
            kategori: $('#kategori').val(),
            username: $('#username').val(),
            password: CryptoJS.AES.encrypt($('#password').val(), key).toString(),
            pin: CryptoJS.AES.encrypt($('#pin').val(), key).toString(),
            pola: CryptoJS.AES.encrypt($('#pola').val(), key).toString(),
            riwayat: $('#riwayat').val()
        };

        let db = JSON.parse(localStorage.getItem('vault_v3')) || [];
        if (index === "") db.push(dataBaru); else db[index] = dataBaru;

        localStorage.setItem('vault_v3', JSON.stringify(db));
        $('#myModal').modal('hide');
        renderTable();
        Swal.fire('Sukses', 'Data berhasil dienkripsi dan disimpan', 'success');
    });

    function openModalAdd() {
        $('#accountForm')[0].reset();
        $('#editIndex').val('');
        $('#modalTitle').text('Tambah Akun Baru');
        $('#myModal').modal('show');
    }
</script>

</body>
</html>